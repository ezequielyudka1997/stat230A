---
title: "Ezequiel_markdown"
output: pdf_document
date: "2024-04-29"
---

We downloaded the data from here: https://www2.census.gov/programs-surveys/acs/data/pums/2022/1-Year/csv_pus.zip

First, we append the files and then we process the data to reduce the size and 
generate some variables we need
```{r}
if (!require("readr")) install.packages("readr", dependencies = TRUE)
library(readr)

# We append population a, b, c,d  data once
data_a <- read.csv("/Users/zequi/Desktop/Berkeley/230A/csv_pus/psam_pusa.csv")
data_b <- read.csv("/Users/zequi/Desktop/Berkeley/230A/csv_pus/psam_pusb.csv")
data <- rbind(data_a, data_b)

if (!require("dplyr")) install.packages("dplyr", dependencies = TRUE)
library(dplyr)

data <- data %>%
  select(ST, DIVISION, AGEP, ESR, CIT, NATIVITY, CITWP, YOEP, COW, DIS, ENG, PAP, FER, MAR, SEX, SCH, SCHL, PINCP, WAGP, ANC, ANC1P, ANC2P, ESR, MIGSP, POBP, RAC1P, PERNP, HISP, HINS4, ADJINC)

write.csv(data, "psam_pus.csv", row.names = FALSE)
zip("psam_pus.zip", "psam_pus.csv")
file.remove("psam_pus.csv")

processed_data <- data %>%
  filter(AGEP >= 18, !ESR %in% c("b", 6)) %>%
  mutate(
    Citizen = ifelse(CIT %in% c(1, 2, 3, 4), 1, 0),
    Foreign_born = ifelse(NATIVITY == 2, 1, 0),
    High_School_Grad = ifelse(SCHL >= 16 & SCHL < 21, 1, 0),
    Bachelors_Degree = ifelse(SCHL >= 21, 1, 0),
    Unemployed = ifelse(ESR == 3, 1, 0),
    HISP_dummy = ifelse(HISP == 1, 0, 1),
    Years_in_US = 2022 - YOEP,
    Years_naturalized = 2022 - CITWP,
    SEX = as.numeric(SEX) - 1,
    HINS4 = as.numeric(HINS4) - 1,
    Asian = ifelse(RAC1P ==6, 1, 0)
  )

write.csv(processed_data, "processed_data.csv", row.names = FALSE)
zip("processed_data.zip", "processed_data.csv")
file.remove("processed_data.csv")
```

We bring the processed data:
```{r}
zip_file_path <- "/Users/zequi/Desktop/Berkeley/230A/stat230A/processed_data.zip"
csv_file_inside_zip <- "processed_data.csv"

processed_data <- read.csv(unzip(zip_file_path, files = csv_file_inside_zip))
```

We do some extra processing:
```{r}
library(tidyr)
library(dplyr)

processed_data <- processed_data %>%
  mutate(
    DIS = ifelse(DIS == 2, 0, 1), 
    HINS4 = 1 - as.numeric(HINS4),
    Citizen = ifelse(CIT %in% c(1, 3, 4), 1, 0)
  )

processed_data$wb50birth <- processed_data$FER
processed_data$wb50birth[is.na(processed_data$FER) &
                         (processed_data$AGEP >= 50 | processed_data$SEX == 0)] <- 0
processed_data = processed_data%>%filter(CIT != 2)
processed_data$Years_naturalized[processed_data$Foreign_born == 0] <- 0
processed_data$Years_in_US[processed_data$Foreign_born == 0] <- 0
processed_data$Years_in_US[processed_data$CIT == 5] <- 0
processed_data$adj_WAGP = processed_data$WAGP + 1
processed_data = processed_data%>%mutate(immigrant = CIT%in%c(4,5))
```

Logistics regression: Predict Employment status
```{r}
employment_status_model <- glm(Unemployed ~  as.factor(RAC1P) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth + as.factor(ST) + High_School_Grad + Bachelors_Degree + HISP_dummy, data = processed_data, family = binomial())
#summary(employment_status_model)

summary_model <- summary(employment_status_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
summary_model$coefficients <- summary_model$coefficients[!state_rows, ]
summary_model
```

```{r}
fitted_probs <- fitted(employment_status_model)
residuals <- residuals(employment_status_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(employment_status_model, type = "HC0")
variances <- diag(v)
std_errors <- sqrt(diag(v))
conf_intervals <- sweep(exp(coef(employment_status_model) + qnorm(c(0.025, 0.975)) %o% std_errors), 2, exp(coef(employment_status_model)), "*")
print(conf_intervals)
results <- data.frame(Coefficients = exp(coef(employment_status_model)), Lower = conf_intervals[1,], Upper = conf_intervals[2,])
non_state_vars <- !grepl("as\\.factor\\(ST\\)\\d+", rownames(results))
filtered_results <- results[non_state_vars, ]
print(filtered_results)
```

Logistics regression: Risk of poverty
```{r}
processed_data$PAP_binary = as.numeric(processed_data$PAP > 0)
poverty_risk_model <- glm(PAP_binary ~ as.factor(RAC1P) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth+ Unemployed + as.factor(ST) + High_School_Grad + Bachelors_Degree + HISP_dummy + as.factor(MAR), family = binomial(), data = processed_data)
#summary(poverty_risk_model)

summary_model <- summary(poverty_risk_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
summary_model$coefficients <- summary_model$coefficients[!state_rows, ]
summary_model
```
```{r}
fitted_probs <- fitted(poverty_risk_model)
residuals <- residuals(poverty_risk_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(poverty_risk_model, type = "HC0")
std_errors <- sqrt(diag(v))
conf_intervals <- sweep(exp(coef(poverty_risk_model) + qnorm(c(0.025, 0.975)) %o% std_errors), 2, exp(coef(poverty_risk_model)), "*")
print(conf_intervals)
results <- data.frame(Coefficients = exp(coef(poverty_risk_model)), Lower = conf_intervals[1,], Upper = conf_intervals[2,])
non_state_vars <- !grepl("as\\.factor\\(ST\\)\\d+", rownames(results))
filtered_results <- results[non_state_vars, ]
print(filtered_results)
```
Logistics regression: Probability of being on medicaid (HINS4)
```{r}
medicaid_model <- glm(HINS4 ~ as.factor(RAC1P) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth+ Unemployed + as.factor(ST) + High_School_Grad + Bachelors_Degree + HISP_dummy + as.factor(MAR), family = binomial(), data = processed_data)
#summary(medicaid_model)

summary_model <- summary(medicaid_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
summary_model$coefficients <- summary_model$coefficients[!state_rows, ]
summary_model
```
```{r}
fitted_probs <- fitted(medicaid_model)
residuals <- residuals(medicaid_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(medicaid_model, type = "HC0")
variances <- diag(v)
std_errors <- sqrt(diag(v))
conf_intervals <- sweep(exp(coef(medicaid_model) + qnorm(c(0.025, 0.975)) %o% std_errors), 2, exp(coef(medicaid_model)), "*")
print(conf_intervals)
results <- data.frame(Coefficients = exp(coef(medicaid_model)), Lower = conf_intervals[1,], Upper = conf_intervals[2,])
non_state_vars <- !grepl("as\\.factor\\(ST\\)\\d+", rownames(results))
filtered_results <- results[non_state_vars, ]
print(filtered_results)
```

```{r}
#missing_percentage <- processed_data %>%
#  summarise(
#    Missing_Citizen = sum(is.na(Citizen)) / n() * 100,
#    Missing_Foreign_born = sum(is.na(Foreign_born)) / n() * 100,
#    Missing_FER = sum(is.na(FER)) / n() * 100,
#    Missing_ENG = sum(is.na(ENG)) / n() * 100
#  )

#View(missing_percentage)
```

Repeat the exercise for top Hispanic origins
```{r}
immigrants_only = processed_data%>%filter(CIT%in% c(4,5))
immigrants_only2 = immigrants_only%>%filter(RAC1P%in%c(1,2,6,8,9))
hisp_only = processed_data%>%filter(HISP_dummy==1)
hisp_only_im = immigrants_only2%>%filter(HISP_dummy==1)

largest_subgroup = hisp_only_im%>%group_by(POBP)%>%
  summarise(count = n())%>%
  mutate(per = (count/sum(count))*100)%>%
  arrange(desc(per))%>%head(5)%>%pull(POBP)

hisp_only_im = hisp_only_im%>%filter(POBP %in% largest_subgroup)
```

Hispanic immigrants
```{r}
hisp_only_employment_status_model <- glm(Unemployed ~  as.factor(POBP) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth + as.factor(ST) + High_School_Grad + Bachelors_Degree + PAP + HINS4 + immigrant, data = hisp_only_im, family = binomial())
#summary(hisp_only_employment_status_model)

summary_model <- summary(hisp_only_employment_status_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
filtered_coefficients <- summary_model$coefficients[!state_rows, ]
summary_model$coefficients <- filtered_coefficients
print(summary_model$coefficients)
```
```{r}
fitted_probs <- fitted(hisp_only_employment_status_model)
residuals <- residuals(hisp_only_employment_status_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(hisp_only_employment_status_model, type = "HC0")
variances <- diag(v)
std_errors <- sqrt(diag(v))
coefficients <- coef(hisp_only_employment_status_model)
exp_coefficients <- exp(coefficients)
lower_bound <- exp_coefficients * exp(-1.96 * std_errors)
upper_bound <- exp_coefficients * exp(1.96 * std_errors)
results <- data.frame(
  Coefficients = exp_coefficients,
  Lower_CI = lower_bound,
  Upper_CI = upper_bound
)
state_var_pattern <- "^as\\.factor\\(ST\\)"
results <- results[!grepl(state_var_pattern, rownames(results)), ]
print(results)
```

```{r}
hisp_only_poverty_risk_model <- glm(PAP_binary ~ as.factor(POBP) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth+ Unemployed + as.factor(ST) + High_School_Grad + Bachelors_Degree + as.factor(MAR) + immigrant, family = binomial(), data = hisp_only_im)
#summary(hisp_only_poverty_risk_model)

summary_model <- summary(hisp_only_poverty_risk_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
filtered_coefficients <- summary_model$coefficients[!state_rows, ]
summary_model$coefficients <- filtered_coefficients
print(summary_model$coefficients)
```
```{r}
fitted_probs <- fitted(hisp_only_poverty_risk_model)
residuals <- residuals(hisp_only_poverty_risk_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(hisp_only_poverty_risk_model, type = "HC0")
variances <- diag(v)
std_errors <- sqrt(diag(v))
coefficients <- coef(hisp_only_poverty_risk_model)
exp_coefficients <- exp(coefficients)
lower_bound <- exp_coefficients * exp(-1.96 * std_errors)
upper_bound <- exp_coefficients * exp(1.96 * std_errors)
results <- data.frame(
  Coefficients = exp_coefficients,
  Lower_CI = lower_bound,
  Upper_CI = upper_bound
)
state_var_pattern <- "^as\\.factor\\(ST\\)"
results <- results[!grepl(state_var_pattern, rownames(results)), ]
print(results)
```

```{r}
hisp_only_medicaid_model <- glm(HINS4 ~ as.factor(POBP) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth+ Unemployed + as.factor(ST) + High_School_Grad + Bachelors_Degree + as.factor(MAR) + immigrant, family = binomial(), data = hisp_only_im)
#summary(hisp_only_medicaid_model)
summary_model <- summary(hisp_only_medicaid_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
filtered_coefficients <- summary_model$coefficients[!state_rows, ]
summary_model$coefficients <- filtered_coefficients
print(summary_model$coefficients)
```
```{r}
fitted_probs <- fitted(hisp_only_medicaid_model)
residuals <- residuals(hisp_only_medicaid_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(hisp_only_medicaid_model, type = "HC0")
variances <- diag(v)
std_errors <- sqrt(diag(v))
coefficients <- coef(hisp_only_medicaid_model)
exp_coefficients <- exp(coefficients)
lower_bound <- exp_coefficients * exp(-1.96 * std_errors)
upper_bound <- exp_coefficients * exp(1.96 * std_errors)
results <- data.frame(
  Coefficients = exp_coefficients,
  Lower_CI = lower_bound,
  Upper_CI = upper_bound
)
state_var_pattern <- "^as\\.factor\\(ST\\)"
results <- results[!grepl(state_var_pattern, rownames(results)), ]
print(results)
```

Repeat the exercise for top Asian origins
```{r}
asian_only = processed_data%>%filter(Asian==1)
asian_only_im = immigrants_only2%>%filter(Asian==1)

largest_subgroup = asian_only_im%>%group_by(POBP)%>%
  summarise(count = n())%>%
  mutate(per = (count/sum(count))*100)%>%
  arrange(desc(per))%>%head(5)%>%pull(POBP)

asian_only_im = asian_only_im%>%filter(POBP %in% largest_subgroup)
```

```{r}
asian_only_employment_status_model <- glm(Unemployed ~  as.factor(POBP) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth + as.factor(ST) + High_School_Grad + Bachelors_Degree + PAP + HINS4 + immigrant, data = asian_only_im, family = binomial())
#summary_model <- summary(asian_only_employment_status_model)
summary_model <- summary(asian_only_employment_status_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
filtered_coefficients <- summary_model$coefficients[!state_rows, ]
summary_model$coefficients <- filtered_coefficients
print(summary_model$coefficients)
```
```{r}
fitted_probs <- fitted(asian_only_employment_status_model)
residuals <- residuals(asian_only_employment_status_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(asian_only_employment_status_model, type = "HC0")
variances <- diag(v)
std_errors <- sqrt(diag(v))
coefficients <- coef(asian_only_employment_status_model)
exp_coefficients <- exp(coefficients)
lower_bound <- exp_coefficients * exp(-1.96 * std_errors)
upper_bound <- exp_coefficients * exp(1.96 * std_errors)
results <- data.frame(
  Coefficients = exp_coefficients,
  Lower_CI = lower_bound,
  Upper_CI = upper_bound
)
state_var_pattern <- "^as\\.factor\\(ST\\)"
results <- results[!grepl(state_var_pattern, rownames(results)), ]
print(results)
```

```{r}
asian_only_poverty_risk_model <- glm(PAP_binary ~ as.factor(POBP) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth+ Unemployed + as.factor(ST) + High_School_Grad + Bachelors_Degree + as.factor(MAR) + immigrant, family = binomial(), data = asian_only_im)
summary_model <- summary(asian_only_poverty_risk_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
filtered_coefficients <- summary_model$coefficients[!state_rows, ]
summary_model$coefficients <- filtered_coefficients
print(summary_model$coefficients)
```
```{r}
fitted_probs <- fitted(asian_only_poverty_risk_model)
residuals <- residuals(asian_only_poverty_risk_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(asian_only_poverty_risk_model, type = "HC0")
variances <- diag(v)
std_errors <- sqrt(diag(v))
coefficients <- coef(asian_only_poverty_risk_model)
exp_coefficients <- exp(coefficients)
lower_bound <- exp_coefficients * exp(-1.96 * std_errors)
upper_bound <- exp_coefficients * exp(1.96 * std_errors)
results <- data.frame(
  Coefficients = exp_coefficients,
  Lower_CI = lower_bound,
  Upper_CI = upper_bound
)
state_var_pattern <- "^as\\.factor\\(ST\\)"
results <- results[!grepl(state_var_pattern, rownames(results)), ]
print(results)
```

```{r}
asian_only_medicaid_model <- glm(HINS4 ~ as.factor(POBP) + AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth+ Unemployed + as.factor(ST) + High_School_Grad + Bachelors_Degree + as.factor(MAR) + immigrant, family = binomial(), data = hisp_only_im)
summary_model <- summary(asian_only_medicaid_model)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
filtered_coefficients <- summary_model$coefficients[!state_rows, ]
summary_model$coefficients <- filtered_coefficients
print(summary_model$coefficients)
```
```{r}
fitted_probs <- fitted(asian_only_medicaid_model)
residuals <- residuals(asian_only_medicaid_model, type = "response")
library(sandwich)
library(lmtest)
v <- vcovHC(asian_only_medicaid_model, type = "HC0")
variances <- diag(v)
std_errors <- sqrt(diag(v))
coefficients <- coef(asian_only_poverty_risk_model)
exp_coefficients <- exp(coefficients)
lower_bound <- exp_coefficients * exp(-1.96 * std_errors)
upper_bound <- exp_coefficients * exp(1.96 * std_errors)
results <- data.frame(
  Coefficients = exp_coefficients,
  Lower_CI = lower_bound,
  Upper_CI = upper_bound
)
state_var_pattern <- "^as\\.factor\\(ST\\)"
results <- results[!grepl(state_var_pattern, rownames(results)), ]
print(results)
```

Blinder Oxaca

```{r}
if (!require(oaxaca)) install.packages("oaxaca")
library(oaxaca)

oaxaca_data <- processed_data[processed_data$PERNP > 0, ]
oaxaca_data$PERNP <- as.numeric(oaxaca_data$PERNP)
oaxaca_data <- oaxaca_data[!(oaxaca_data$HISP_dummy == 1 & oaxaca_data$Asian == 1), ]
```

Ethnic Blinder Oxaca
```{r}
oaxaca_data$Ethnic_interest <- ifelse(oaxaca_data$HISP_dummy == 1 | oaxaca_data$Asian == 1, 1, 0)
oaxaca_data$Ethnic_interest <- as.factor(oaxaca_data$Ethnic_interest)

ethnic_oaxaca <- oaxaca(
  formula = log(adj_WAGP) ~ AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth+ Unemployed + as.factor(ST) + High_School_Grad + Bachelors_Degree + as.factor(MAR) + PAP + HINS4 | Ethnic_interest,
  data = oaxaca_data
)
View(summary(ethnic_oaxaca))
```

```{r}
summary_model <- summary(ethnic_oaxaca$reg$reg.A)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
summary_model$coefficients <- summary_model$coefficients[!state_rows, ]
print(summary_model$coefficients)
```

```{r}
summary_model <- summary(ethnic_oaxaca$reg$reg.B)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
summary_model$coefficients <- summary_model$coefficients[!state_rows, ]
print(summary_model$coefficients)
```


```{r}
library(ggplot2)

overall_effects <- data.frame(
  Effect = c("Endowments", "Coefficients", "Interaction"),
  Coefficient = c(ethnic_oaxaca$threefold$overall["coef(endowments)"],
                  ethnic_oaxaca$threefold$overall["coef(coefficients)"],
                  ethnic_oaxaca$threefold$overall["coef(interaction)"]),
  StandardError = c(ethnic_oaxaca$threefold$overall["se(endowments)"],
                    ethnic_oaxaca$threefold$overall["se(coefficients)"],
                    ethnic_oaxaca$threefold$overall["se(interaction)"])
)

variable_effects <- data.frame(
  Variable = rownames(ethnic_oaxaca$threefold$variables),
  Endowments = ethnic_oaxaca$threefold$variables[, "coef(endowments)"],
  Endowments_SE = ethnic_oaxaca$threefold$variables[, "se(endowments)"],
  Coefficients = ethnic_oaxaca$threefold$variables[, "coef(coefficients)"],
  Coefficients_SE = ethnic_oaxaca$threefold$variables[, "se(coefficients)"]
)

selected_variables <- c("AGEP", "SEX", "Citizen", "as.factor(ENG)2", "as.factor(ENG)3",
                        "as.factor(ENG)4", "DIS", "Unemployed", "High_School_Grad",
                        "Bachelors_Degree", "PAP", "HINS4",
                        "SEX:Citizen", "SEX:DIS")

filtered_variable_effects <- variable_effects[variable_effects$Variable %in% selected_variables, ]

ggplot(filtered_variable_effects, aes(x = Variable, y = Endowments, fill = "Endowments")) +
  geom_col(color = "black", position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = Endowments - Endowments_SE, ymax = Endowments + Endowments_SE), width = 0.2, position = position_dodge(width = 0.9)) +
  labs(title = "Endowment Effects for Selected Variables", x = NULL, y = "Endowment Effect") +
  scale_fill_manual(values = c("Endowments" = "blue")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(filtered_variable_effects, aes(x = Variable, y = Coefficients, fill = "Coefficients")) +
  geom_col(color = "black", position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = Coefficients - Coefficients_SE, ymax = Coefficients + Coefficients_SE), width = 0.2, position = position_dodge(width = 0.9)) +
  labs(title = "Coefficient Effects for Selected Variables", x = NULL, y = "Coefficient Effect") +
  scale_fill_manual(values = c("Coefficients" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Migrant Blinder Oxaca
```{r}
migrant_oaxaca <- oaxaca(
  formula = log(adj_WAGP) ~  AGEP + SEX*Citizen + as.factor(ENG) + SEX*DIS + wb50birth+ Unemployed + as.factor(ST) + High_School_Grad + Bachelors_Degree + as.factor(MAR) + PAP + HINS4 | Foreign_born,
  data = oaxaca_data
)
#+ SEX*Citizen, as.factor(RAC1P) +
View(summary(migrant_oaxaca))
```

```{r}
summary_model <- summary(migrant_oaxaca$reg$reg.A)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
summary_model$coefficients <- summary_model$coefficients[!state_rows, ]
print(summary_model$coefficients)
```

```{r}
summary_model <- summary(migrant_oaxaca$reg$reg.B)
state_rows <- grepl("^as\\.factor\\(ST\\)", rownames(summary_model$coefficients))
summary_model$coefficients <- summary_model$coefficients[!state_rows, ]
print(summary_model$coefficients)
```

```{r}
overall_effects <- data.frame(
  Effect = c("Endowments", "Coefficients", "Interaction"),
  Coefficient = c(migrant_oaxaca$threefold$overall["coef(endowments)"],
                  migrant_oaxaca$threefold$overall["coef(coefficients)"],
                  migrant_oaxaca$threefold$overall["coef(interaction)"]),
  StandardError = c(migrant_oaxaca$threefold$overall["se(endowments)"],
                    migrant_oaxaca$threefold$overall["se(coefficients)"],
                    migrant_oaxaca$threefold$overall["se(interaction)"])
)

variable_effects <- data.frame(
  Variable = rownames(migrant_oaxaca$threefold$variables),
  Endowments = migrant_oaxaca$threefold$variables[, "coef(endowments)"],
  Endowments_SE = migrant_oaxaca$threefold$variables[, "se(endowments)"],
  Coefficients = migrant_oaxaca$threefold$variables[, "coef(coefficients)"],
  Coefficients_SE = migrant_oaxaca$threefold$variables[, "se(coefficients)"]
)

selected_variables <- c("AGEP", "SEX", "Citizen", "as.factor(ENG)2", "as.factor(ENG)3",
                        "as.factor(ENG)4", "DIS", "Unemployed", "High_School_Grad",
                        "Bachelors_Degree", "HISP_dummy", "PAP", "HINS4",
                        "SEX:Citizen", "SEX:DIS")

filtered_variable_effects <- variable_effects[variable_effects$Variable %in% selected_variables, ]

ggplot(filtered_variable_effects, aes(x = Variable, y = Endowments, fill = "Endowments")) +
  geom_col(color = "black", position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = Endowments - Endowments_SE, ymax = Endowments + Endowments_SE), width = 0.2, position = position_dodge(width = 0.9)) +
  labs(title = "Endowment Effects for Selected Variables", x = NULL, y = "Endowment Effect") +
  scale_fill_manual(values = c("Endowments" = "blue")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(filtered_variable_effects, aes(x = Variable, y = Coefficients, fill = "Coefficients")) +
  geom_col(color = "black", position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = Coefficients - Coefficients_SE, ymax = Coefficients + Coefficients_SE), width = 0.2, position = position_dodge(width = 0.9)) +
  labs(title = "Coefficient Effects for Selected Variables", x = NULL, y = "Coefficient Effect") +
  scale_fill_manual(values = c("Coefficients" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
